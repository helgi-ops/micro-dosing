<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Player</title>
    <link rel="stylesheet" href="./assets/ui.css" />
    <script>
      // Supabase public client config (anon key is safe to expose)
      window.__SUPABASE_URL__ = "https://tbtkxttiwbdmugjivmvb.supabase.co";
      window.__SUPABASE_ANON_KEY__ = "sb_publishable_7ePvUt_6A7KKyGpV7eYfaQ_3w81AUuA";
    </script>
    <style>
      .wrap { max-width: 980px; margin: 0 auto; padding: 18px; }
      .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
      .card { background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.08); border-radius: 14px; padding: 14px; }
      .muted { opacity: .75; }
      .kvs { display:grid; grid-template-columns: 160px 1fr; gap: 6px 10px; }
      .actions { display:flex; gap:10px; flex-wrap:wrap; }
      button { cursor:pointer; }
      .danger { border-color: rgba(255,80,80,.45); }
      .list { margin: 0; padding-left: 18px; }
      .pill { display:inline-block; padding: 4px 10px; border-radius: 999px; border: 1px solid rgba(255,255,255,.15); }
      .spacer { height: 10px; }
      a { color: inherit; }
      .is-hidden { display:none !important; }
      #player-shell { max-width: 1000px; margin: 0 auto; padding: 18px; display:grid; gap:16px; }
      .player-header { display:flex; justify-content:space-between; align-items:flex-start; gap:12px; }
      .player-header__left h1 { margin:0; font-size:24px; }
      .badge { display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.15); font-weight:700; }
      #player-flow { display:grid; gap:14px; }
      #slot-header, #slot-today, #slot-checkin, #slot-cmj, #slot-week, #slot-upcoming { display:block; }
      .subcard { margin-top: 12px; }
      .items-list { list-style: none; padding: 0; margin: 0; }
      .item-row { padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.08); }
      .item-row:last-child { border-bottom: none; }
    </style>
  </head>
  <body>
    <div id="player-shell">
      <header class="player-header card" id="player-header-card">
        <div class="player-header__left">
          <h1 id="playerName">Player</h1>
          <div class="muted" id="player-subtitle">Loading…</div>
        </div>
        <div class="player-header__right">
          <span class="badge" id="assigned-week-badge">No week assigned</span>
        </div>
      </header>

      <main id="player-flow">
        <div id="slot-header"></div>
        <div id="slot-today"></div>
        <div id="slot-checkin"></div>
        <div id="slot-upcoming"></div>
        <div id="slot-cmj"></div>
        <div id="slot-week"></div>
      </main>
    </div>

    <section class="card" id="player-week-view">
      <div class="card-header">
        <h3>Vikan mín</h3>
      </div>
      <div class="card-body">
        <div id="week-meta" class="hint"></div>
        <div id="week-days-container"></div>
      </div>
    </section>

    <div class="wrap is-hidden" id="player-duplicates">
      <div class="row" style="justify-content:space-between;">
        <div class="row">
          <a href="./coach.html" class="muted">← Back</a>
          <span class="muted">/</span>
          <strong id="crumbName">Player</strong>
        </div>
        <span id="status" class="muted">Loading…</span>
      </div>

      <div class="spacer"></div>

      <h1 id="playerNameLegacy">Player</h1>

      <div class="card is-hidden" id="playerCard">
        <div class="row" style="justify-content:space-between;">
          <div>
            <div style="font-size:22px; font-weight:700;" id="playerNameCard">—</div>
          </div>
        </div>
      </div>

      <div class="spacer"></div>

      <div class="card is-hidden">
        <div class="row" style="justify-content:space-between;">
          <strong>Assigned week preview</strong>
          <span class="muted" id="weeksCount">—</span>
        </div>
        <div class="spacer"></div>
        <ul class="list" id="weeksList"></ul>
        <div class="muted" id="weeksEmpty" style="display:none;">No assigned week found.</div>
      </div>

      <div class="spacer"></div>

      <section id="weekPreview" class="is-hidden">
        <h2>Vikan þín</h2>
        <div id="weekBox"></div>
      </section>

      <div class="spacer"></div>

      <div class="card" id="readinessCard">
        <div class="row" style="justify-content:space-between;">
          <strong>Readiness (today)</strong>
          <span class="muted" id="checkinStatus">Not submitted</span>
        </div>
        <div class="spacer"></div>
        <div class="readiness-body">
          <div class="readiness-summary muted">Answer honestly — this adjusts today’s training load.</div>
          <div class="readiness-tiles">
            <div class="tile">
              <h4>Readiness</h4>
              <div class="sub">How ready you feel right now (1–10)</div>
              <select id="readinessInput" class="tile-select">
                <option value="" disabled selected>Select readiness…</option>
                <option value="1">1 — Very low energy / heavy fatigue</option>
                <option value="2">2 — Very low energy / heavy fatigue</option>
                <option value="3">3 — Very low energy / heavy fatigue</option>
                <option value="4">4 — OK / not at your best</option>
                <option value="5">5 — OK / not at your best</option>
                <option value="6">6 — OK / not at your best</option>
                <option value="7">7 — Good / ready to train</option>
                <option value="8">8 — Good / ready to train</option>
                <option value="9">9 — Excellent / fully primed</option>
                <option value="10">10 — Excellent / fully primed</option>
              </select>
            </div>
            <div class="tile">
              <h4>Soreness</h4>
              <div class="sub">Muscle soreness today (1–5)</div>
              <select id="sorenessInput" class="tile-select">
                <option value="" disabled selected>Select soreness…</option>
                <option value="1">1 — No soreness</option>
                <option value="2">2 — Mild soreness (no limitation)</option>
                <option value="3">3 — Noticeable soreness (manageable)</option>
                <option value="4">4 — High soreness (affects movement)</option>
                <option value="5">5 — Very sore or painful</option>
              </select>
            </div>
            <div class="tile">
              <h4>Sleep</h4>
              <div class="sub">Last night (0–2)</div>
              <div class="seg" id="sleepSeg">
                <button type="button" data-sleep="0">0 Poor</button>
                <button type="button" data-sleep="1">1 OK</button>
                <button type="button" data-sleep="2">2 Good</button>
              </div>
              <input id="sleepInput" type="hidden" value="" />
            </div>
          </div>
          <div class="actions-row">
            <button id="saveCheckinBtn">Save check-in</button>
            <span class="muted" id="checkinStatusInline"></span>
          </div>
        </div>
      </div>

      <div class="spacer"></div>

      <section class="card" style="margin-top:16px;" id="upcoming-week-card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
          <h3 style="margin:0;">Upcoming Week</h3>
          <div id="assigned-week-meta" class="muted"></div>
        </div>

        <div id="assigned-week-status" class="muted" style="margin-top:8px;"></div>

        <div id="assigned-week-days" style="display:grid; grid-template-columns:repeat(7, minmax(0,1fr)); gap:10px; margin-top:12px;"></div>
      </section>

      <div class="spacer"></div>

      <div class="card" id="cmjCard">
        <div class="row" style="justify-content:space-between;">
          <strong>CMJ test</strong>
          <span class="muted" id="cmjStatus">No test today</span>
        </div>
        <div class="spacer"></div>
        <div class="row">
          <label>CMJ value (cm)<br/><input id="cmjInput" type="number" min="0" step="0.1" /></label>
          <div class="muted">
            <div>All-time best: <span id="cmjBest">—</span></div>
            <div>Most recent: <span id="cmjRecent">—</span></div>
            <div>% of best: <span id="cmjPct">—</span></div>
          </div>
        </div>
        <div class="spacer"></div>
        <button id="saveCmjBtn">Save CMJ</button>
      </div>

      <div class="spacer"></div>

      <div class="card" id="assignCard" data-role="today-card">
        <div class="row" style="justify-content:space-between;">
          <strong>Today’s workout</strong>
        </div>
        <div class="spacer"></div>
        <div id="workoutArea" class="muted">No workout assigned yet.</div>
      </div>
    </div>

    <script type="module">
      import { requirePlayerAuth } from "./assets/player-auth-guard.js";
      import { supabase, api } from "./assets/dataClient.js";
      import { requireSessionOrRedirect } from "./assets/app-auth.js";

      (async function () {
        const statusEl = document.getElementById("assigned-week-status");
        const metaEl = document.getElementById("assigned-week-meta");
        const daysEl = document.getElementById("assigned-week-days");
        const badgeEl = document.getElementById("assigned-week-badge");

        const setStatus = (msg) => { if (statusEl) statusEl.textContent = msg || ""; };

        const escapeHtml = (str) =>
          (str || "").toString().replace(/[&<>\"']/g, (m) => ({
            "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#039;"
          }[m]));

        const dayCard = (title, type, load) => `
          <div style="border:1px solid rgba(255,255,255,0.08); border-radius:14px; padding:10px; min-height:80px;">
            <div style="font-weight:700; margin-bottom:6px;">${escapeHtml(title)}</div>
            <div class="muted" style="font-size:12px;">${escapeHtml(type || "")}</div>
            <div class="muted" style="font-size:12px;">${escapeHtml(load || "")}</div>
          </div>
        `;

        try {
          setStatus("Loading assigned week...");
        const { data: sess } = await supabase.auth.getSession();
        const userId = sess?.session?.user?.id;
        if (!userId) {
          setStatus("Not signed in.");
          return;
          }

          const { data: player, error: pErr } = await supabase
            .from("players")
            .select("id, team_id, first_name, last_name")
            .eq("auth_user_id", userId)
            .maybeSingle();
          if (pErr) throw pErr;
          if (!player) {
            setStatus("No player profile found for this account.");
            return;
          }

          const { data: assignment, error: aErr } = await supabase
            .from("week_assignments")
            .select("week_id, status, assigned_at")
            .eq("player_id", player.id)
            .in("status", ["assigned","active"])
            .order("assigned_at", { ascending: false })
            .limit(1)
            .maybeSingle();
          if (aErr) throw aErr;

          if (!assignment) {
            setStatus("No week assigned yet. Tap refresh in a moment.");
            if (metaEl) metaEl.textContent = "";
            if (daysEl) daysEl.innerHTML = "";
            if (badgeEl) badgeEl.textContent = "No week assigned";
            return;
          }

          const { data: week, error: wErr } = await supabase
            .from("weeks")
            .select("id, week_number, title, start_date, end_date, status")
            .eq("id", assignment.week_id)
            .single();
          if (wErr) throw wErr;

          const label = `Week ${week.week_number || ""}${week.status ? " • " + week.status : ""}`.trim();
          if (metaEl) metaEl.textContent = label;
          if (badgeEl) badgeEl.textContent = label || "Week assigned";

          const { data: days, error: dErr } = await supabase
            .from("week_days")
            .select("*")
            .eq("week_id", assignment.week_id)
            .order("day_index", { ascending: true });
          if (dErr) throw dErr;

          if (!Array.isArray(days) || days.length === 0) {
            setStatus("Week is assigned, but no days to render.");
            if (daysEl) daysEl.innerHTML = "";
            return;
          }

          setStatus("");
          const fallbackNames = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
          const display = days.slice(0, 7).map((d, i) => {
            const title = d.day_name || d.title || fallbackNames[i] || `Day ${i+1}`;
            const type = d.day_type || d.type || d.session_type || "";
            const load = d.load || d.exposure || d.load_exposure || "";
            return dayCard(title, type, load);
          });
          if (daysEl) daysEl.innerHTML = display.join("");
        } catch (err) {
          console.error(err);
          setStatus(`Error loading assigned week: ${err.message || err}`);
        }
      })();
    </script>
    <script type="module" src="./assets/player-token.js"></script>
  </body>
  <script type="module">
    import { api } from "./assets/dataClient.js";

    function getPlayerIdFromUrl() {
      const url = new URL(window.location.href);
      return url.searchParams.get("id");
    }

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function setWeekMeta(text) {
      const el = document.getElementById("week-meta");
      if (!el) return;
      el.textContent = text || "";
    }

    function renderWeekDays({ days, weekDaysByIndex }) {
      const root = document.getElementById("week-days-container");
      if (!root) return;

      root.innerHTML = "";

      if (!days?.length) {
        root.innerHTML = `<div class="hint">Engir dagar fundust í template.</div>`;
        return;
      }

      for (const d of days) {
        const dayIndex = d.day_index ?? null;
        const dateStr = (dayIndex != null && weekDaysByIndex.has(dayIndex))
          ? weekDaysByIndex.get(dayIndex)
          : null;

        const items = (d.program_template_items || []).map(it => {
          const sets = it.sets != null ? `${it.sets}x` : "";
          const reps = it.reps != null ? `${it.reps}` : "";
          const prescription = (sets || reps) ? ` — ${sets}${reps}` : "";
          const type = it.item_type ? ` <span class="hint">(${escapeHtml(it.item_type)})</span>` : "";

          return `
            <li class="item-row">
              <div>
                <strong>${escapeHtml(it.name || "Item")}</strong>${type}
                <div class="hint">${escapeHtml(prescription)}</div>
              </div>
            </li>
          `;
        }).join("");

        const dayCard = document.createElement("div");
        dayCard.className = "card subcard";
        dayCard.innerHTML = `
          <div class="card-header">
            <h4>Dagur ${escapeHtml(dayIndex ?? "")}</h4>
            <div class="hint">${dateStr ? escapeHtml(dateStr) : ""}</div>
          </div>
          <div class="card-body">
            ${d.notes ? `<div class="hint">${escapeHtml(d.notes)}</div>` : ""}
            <ul class="items-list">
              ${items || `<li class="hint">Engin items.</li>`}
            </ul>
          </div>
        `;

        root.appendChild(dayCard);
      }
    }

    async function loadReadOnlyWeekView() {
      let playerId = getPlayerIdFromUrl();
      if (!playerId) {
        playerId = await api.getMyPlayerId();
      }
      if (!playerId) {
        setWeekMeta("Vantar player id (hvorki í URL né player_users mapping).");
        return;
      }

      const assignment = await api.getLatestWeekAssignmentForPlayer(playerId);
      if (!assignment?.weeks?.id) {
        setWeekMeta("Engin vika er úthlutuð ennþá.");
        return;
      }

      const week = assignment.weeks;
      if (!week.source_template_id) {
        setWeekMeta("Þessi vika er ekki tengd við template (weeks.source_template_id er tómt).");
        return;
      }

      const { template, days } = await api.getProgramTemplateWithDaysAndItems(week.source_template_id);
      const weekDays = await api.getWeekDays(week.id);
      const weekDaysByIndex = new Map();
      for (const wd of weekDays) {
        if (wd?.day_index != null && wd?.date) {
          weekDaysByIndex.set(wd.day_index, wd.date);
        }
      }

      const weekTitle = week.title || `Week ${week.week_number ?? ""}`;
      const templateTitle = template?.title || "Template";
      setWeekMeta(`${weekTitle} — ${templateTitle}`);

      renderWeekDays({ days, weekDaysByIndex });
    }

    function applyPlayerFlowLayout() {
      const move = (slotId, elId) => {
        const slot = document.getElementById(slotId);
        const el = document.getElementById(elId);
        if (slot && el) slot.appendChild(el);
      };
      move('slot-header', 'player-header-card');
      move('slot-today', 'assignCard');
      move('slot-checkin', 'readinessCard');
      move('slot-upcoming', 'upcoming-week-card');
      move('slot-cmj', 'cmjCard');
      move('slot-week', 'player-week-view');

      const dup = document.getElementById('player-duplicates');
      if (dup) dup.style.display = 'none';
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const session = await requireSessionOrRedirect();
      if (!session) return;
      applyPlayerFlowLayout();
      await requirePlayerAuth(); // ensure recovery/invite is handled
      loadReadOnlyWeekView().catch(err => {
        console.error(err);
        setWeekMeta(err?.message || "Villa við að hlaða viku.");
      });
    });
  </script>
</html>
